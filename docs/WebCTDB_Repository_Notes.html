<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html><head>
<meta content="text/html; charset=ISO-8859-1" http-equiv="content-type"><title>WebCT-DB Repository Notes</title></head>
<body>
<h1>WebCT-DB Repository Notes</h1>
<p>Chris Greenhalgh, 2011-07-04</p>
<p>A first integration point between WebCT-DB and Moodle is the
Moodle 2.0 Repository API, a standard extension point for extenal (file
and link) repositories. This document describes a RESTful web service
interface to WebCT-DB initially to support the Repository API.</p>
<h2> The Repository API</h2>
<p>The main methods of relevance are (<a href="http://docs.moodle.org/dev/Repository_plugins">http://docs.moodle.org/dev/Repository_plugins</a>):</p>
<ul>
<li>
get_listing($path='',
$page=''') - returns a list of files like this:<br><span class="Apple-style-span" style="border-collapse: separate; color: rgb(0, 0, 0); font-family: 'Times New Roman'; font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; line-height: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; font-size: medium;"><span class="Apple-style-span" style="font-family: 'Lucida Sans Unicode','Lucida Grande',sans-serif; font-size: 13px; line-height: 18px;"><pre class="php" style="border: 1px dashed rgb(255, 181, 58); padding: 1em; color: black; background-color: rgb(249, 249, 249); line-height: 1.4em; font-size: 13px;"><span style="color: rgb(153, 0, 0);">array</span><span style="color: rgb(0, 153, 0);">(</span><br>   <span style="color: rgb(102, 102, 102); font-style: italic;">// Used to build navegation bar, so you need to include all parents folders</span><br>   <span style="color: rgb(102, 102, 102); font-style: italic;">// array(array('name'=&gt;'root','path'=&gt;'/'), array('name'=&gt;'subfolder', 'path'=&gt;'/subfolder'))</span><br>   <span style="color: rgb(0, 0, 255);">'path'</span> <span style="color: rgb(51, 153, 51);">=&gt;</span> <span style="color: rgb(0, 153, 0);">(</span><span style="color: rgb(153, 0, 0);">array</span><span style="color: rgb(0, 153, 0);">)</span> this will be used to build navigation bar<br>   <span style="color: rgb(102, 102, 102); font-style: italic;">// dynload tells file picker to fetch list dynamically, when user click</span><br>   <span style="color: rgb(102, 102, 102); font-style: italic;">// the folder, it will send a ajax request to server side.</span><br>   <span style="color: rgb(102, 102, 102); font-style: italic;">// if you are using pagination, 'page' and 'pages' parameters should be used</span><br>   <span style="color: rgb(102, 102, 102); font-style: italic;">// and note, you'd better don't use pagination and page at the same time</span><br>   <span style="color: rgb(0, 0, 255);">'page'</span> <span style="color: rgb(51, 153, 51);">=&gt;</span> <span style="color: rgb(0, 153, 0);">(</span>int<span style="color: rgb(0, 153, 0);">)</span> which page is this <span style="color: rgb(153, 0, 0);">list</span><br>   <span style="color: rgb(0, 0, 255);">'pages'</span> <span style="color: rgb(51, 153, 51);">=&gt;</span> <span style="color: rgb(0, 153, 0);">(</span>pages<span style="color: rgb(0, 153, 0);">)</span> how many pages<br>   <span style="color: rgb(0, 0, 255);">'dynload'</span> <span style="color: rgb(51, 153, 51);">=&gt;</span> <span style="color: rgb(0, 153, 0);">(</span>bool<span style="color: rgb(0, 153, 0);">)</span> use dynamic loading<span style="color: rgb(51, 153, 51);">,</span><br>   <span style="color: rgb(102, 102, 102); font-style: italic;">// will display a link in file picker</span><br>   <span style="color: rgb(0, 0, 255);">'manage'</span> <span style="color: rgb(51, 153, 51);">=&gt;</span> <span style="color: rgb(0, 153, 0);">(</span>string<span style="color: rgb(0, 153, 0);">)</span> url of the <span style="color: rgb(153, 0, 0);">file</span> manager<span style="color: rgb(51, 153, 51);">,</span><br>   <span style="color: rgb(102, 102, 102); font-style: italic;">// set to true, the login link will be removed from file picker</span><br>   <span style="color: rgb(0, 0, 255);">'nologin'</span> <span style="color: rgb(51, 153, 51);">=&gt;</span> <span style="color: rgb(0, 153, 0);">(</span>bool<span style="color: rgb(0, 153, 0);">)</span> requires login<span style="color: rgb(51, 153, 51);">,</span><br>   <span style="color: rgb(102, 102, 102); font-style: italic;">// set to true, the search link will be removed from file picker</span><br>   <span style="color: rgb(0, 0, 255);">'nosearch'</span> <span style="color: rgb(51, 153, 51);">=&gt;</span> <span style="color: rgb(0, 153, 0);">(</span>bool<span style="color: rgb(0, 153, 0);">)</span> no search <span style="color: rgb(153, 0, 0);">link</span><span style="color: rgb(51, 153, 51);">,</span><br>   <span style="color: rgb(102, 102, 102); font-style: italic;">// set this option will display a upload form in file picker</span><br>   <span style="color: rgb(102, 102, 102); font-style: italic;">// only used in upload plugin currently</span><br>   <span style="color: rgb(0, 0, 255);">'upload'</span> <span style="color: rgb(51, 153, 51);">=&gt;</span> <span style="color: rgb(153, 0, 0);">array</span><span style="color: rgb(0, 153, 0);">(</span> <span style="color: rgb(102, 102, 102); font-style: italic;">// upload manager</span><br>     <span style="color: rgb(0, 0, 255);">'label'</span> <span style="color: rgb(51, 153, 51);">=&gt;</span> <span style="color: rgb(0, 153, 0);">(</span>string<span style="color: rgb(0, 153, 0);">)</span> label of the form element<span style="color: rgb(51, 153, 51);">,</span><br>     <span style="color: rgb(0, 0, 255);">'id'</span> <span style="color: rgb(51, 153, 51);">=&gt;</span> <span style="color: rgb(0, 153, 0);">(</span>string<span style="color: rgb(0, 153, 0);">)</span> id of the form element<br>   <span style="color: rgb(0, 153, 0);">)</span><span style="color: rgb(51, 153, 51);">,</span><br>   <span style="color: rgb(102, 102, 102); font-style: italic;">// file picker will build a file tree according this </span><br>   <span style="color: rgb(102, 102, 102); font-style: italic;">// list</span><br>   <span style="color: rgb(0, 0, 255);">'list'</span> <span style="color: rgb(51, 153, 51);">=&gt;</span> <span style="color: rgb(153, 0, 0);">array</span><span style="color: rgb(0, 153, 0);">(</span><br>     <span style="color: rgb(153, 0, 0);">array</span><span style="color: rgb(0, 153, 0);">(</span> <span style="color: rgb(102, 102, 102); font-style: italic;">// file</span><br>       <span style="color: rgb(0, 0, 255);">'title'</span> <span style="color: rgb(51, 153, 51);">=&gt;</span> <span style="color: rgb(0, 153, 0);">(</span>string<span style="color: rgb(0, 153, 0);">)</span> <span style="color: rgb(153, 0, 0);">file</span> name<span style="color: rgb(51, 153, 51);">,</span><br>       <span style="color: rgb(0, 0, 255);">'shorttitle'</span> <span style="color: rgb(51, 153, 51);">=&gt;</span> <span style="color: rgb(0, 153, 0);">(</span>string<span style="color: rgb(0, 153, 0);">)</span> optional<span style="color: rgb(51, 153, 51);">,</span> <span style="color: rgb(177, 177, 0);">if</span> you prefer to display a short title<br>       <span style="color: rgb(0, 0, 255);">'date'</span> <span style="color: rgb(51, 153, 51);">=&gt;</span> <span style="color: rgb(0, 153, 0);">(</span>string<span style="color: rgb(0, 153, 0);">)</span> <span style="color: rgb(153, 0, 0);">file</span> last modification <span style="color: rgb(153, 0, 0);">time</span><span style="color: rgb(51, 153, 51);">,</span> usually userdate<span style="color: rgb(0, 153, 0);">(</span><span style="color: rgb(51, 153, 51);">...</span><span style="color: rgb(0, 153, 0);">)</span><span style="color: rgb(51, 153, 51);">,</span><br>       <span style="color: rgb(0, 0, 255);">'size'</span> <span style="color: rgb(51, 153, 51);">=&gt;</span> <span style="color: rgb(0, 153, 0);">(</span>int<span style="color: rgb(0, 153, 0);">)</span> <span style="color: rgb(153, 0, 0);">file</span> size<span style="color: rgb(51, 153, 51);">,</span><br>       <span style="color: rgb(0, 0, 255);">'thumbnail'</span> <span style="color: rgb(51, 153, 51);">=&gt;</span> <span style="color: rgb(0, 153, 0);">(</span>string<span style="color: rgb(0, 153, 0);">)</span> url to thumbnail <span style="color: rgb(177, 177, 0);">for</span> the <span style="color: rgb(153, 0, 0);">file</span><span style="color: rgb(51, 153, 51);">,</span><br>       <span style="color: rgb(0, 0, 255);">'thumbnail_width'</span> <span style="color: rgb(51, 153, 51);">=&gt;</span> <span style="color: rgb(0, 153, 0);">(</span>int<span style="color: rgb(0, 153, 0);">)</span> the width of the thumbnail image<span style="color: rgb(51, 153, 51);">,</span><br>       <span style="color: rgb(0, 0, 255);">'source'</span> <span style="color: rgb(51, 153, 51);">=&gt;</span> plugin<span style="color: rgb(51, 153, 51);">-</span>dependent unique path to the <span style="color: rgb(153, 0, 0);">file</span> <span style="color: rgb(0, 153, 0);">(</span>id<span style="color: rgb(51, 153, 51);">,</span> url<span style="color: rgb(51, 153, 51);">,</span> path<span style="color: rgb(51, 153, 51);">,</span> etc<span style="color: rgb(51, 153, 51);">.</span><span style="color: rgb(0, 153, 0);">)</span><span style="color: rgb(51, 153, 51);">,</span><br>       <span style="color: rgb(0, 0, 255);">'url'</span><span style="color: rgb(51, 153, 51);">=&gt;</span> the accessible url of <span style="color: rgb(153, 0, 0);">file</span><br>     <span style="color: rgb(0, 153, 0);">)</span><span style="color: rgb(51, 153, 51);">,</span><br>     <span style="color: rgb(153, 0, 0);">array</span><span style="color: rgb(0, 153, 0);">(</span> <span style="color: rgb(102, 102, 102); font-style: italic;">// folder - same as file, but no 'source'.</span><br>       <span style="color: rgb(0, 0, 255);">'title'</span> <span style="color: rgb(51, 153, 51);">=&gt;</span> <span style="color: rgb(0, 153, 0);">(</span>string<span style="color: rgb(0, 153, 0);">)</span> folder name<span style="color: rgb(51, 153, 51);">,</span><br>       <span style="color: rgb(0, 0, 255);">'shorttitle'</span> <span style="color: rgb(51, 153, 51);">=&gt;</span> <span style="color: rgb(0, 153, 0);">(</span>string<span style="color: rgb(0, 153, 0);">)</span> optional<span style="color: rgb(51, 153, 51);">,</span> <span style="color: rgb(177, 177, 0);">if</span> you prefer to display a short title<br>       <span style="color: rgb(0, 0, 255);">'path'</span> <span style="color: rgb(51, 153, 51);">=&gt;</span> <span style="color: rgb(0, 153, 0);">(</span>string<span style="color: rgb(0, 153, 0);">)</span> path to this folder<br>       <span style="color: rgb(0, 0, 255);">'date'</span> <span style="color: rgb(51, 153, 51);">=&gt;</span> <span style="color: rgb(0, 153, 0);">(</span>string<span style="color: rgb(0, 153, 0);">)</span> folder last modification <span style="color: rgb(153, 0, 0);">time</span><span style="color: rgb(51, 153, 51);">,</span> usually userdate<span style="color: rgb(0, 153, 0);">(</span><span style="color: rgb(51, 153, 51);">...</span><span style="color: rgb(0, 153, 0);">)</span><span style="color: rgb(51, 153, 51);">,</span><br>       <span style="color: rgb(0, 0, 255);">'size'</span> <span style="color: rgb(51, 153, 51);">=&gt;</span> <span style="color: rgb(204, 102, 204);">0</span><span style="color: rgb(51, 153, 51);">,</span><br>       <span style="color: rgb(0, 0, 255);">'thumbnail'</span> <span style="color: rgb(51, 153, 51);">=&gt;</span> <span style="color: rgb(0, 153, 0);">(</span>string<span style="color: rgb(0, 153, 0);">)</span> url to thumbnail <span style="color: rgb(177, 177, 0);">for</span> the folder<span style="color: rgb(51, 153, 51);">,</span><br>       <span style="color: rgb(0, 0, 255);">'children'</span> <span style="color: rgb(51, 153, 51);">=&gt;</span> <span style="color: rgb(153, 0, 0);">array</span><span style="color: rgb(0, 153, 0);">(</span> <span style="color: rgb(102, 102, 102); font-style: italic;">// an empty folder needs to have 'children' defined, but empty.</span><br>         <span style="color: rgb(102, 102, 102); font-style: italic;">// content (files and folders)</span><br>       <span style="color: rgb(0, 153, 0);">)</span><br>     <span style="color: rgb(0, 153, 0);">)</span><span style="color: rgb(51, 153, 51);">,</span><br>   <span style="color: rgb(0, 153, 0);">)</span><br> <span style="color: rgb(0, 153, 0);">)</span></pre></span></span>(<a href="http://docs.moodle.org/dev/Repository_plugins">http://docs.moodle.org/dev/Repository_plugins</a> - suggests see also repository/boxnet/lib.php)<br></li><ul><li>Essentially,
the file browser calls get_listing initially with no path. It may call
it subsequently with the path(s) returned in the path element
(breadcrumbs) or&nbsp; folder item.</li><li>The full tree can be returned, or dynload set to true and children omitted to force additional (recursive) queries &nbsp;&nbsp;</li><li>Each call needs to return:</li><ul><li>the path as a list of containing contexts, each with their own path and name</li><li>the children - files and folders - of that path, with a url for each file and a path for each folder</li></ul><li>Notes:</li><ul><li>a folder MUST have a children element even if using dynload</li><li>source is used for files, url seems not to be</li><li>other fields include</li><ul><li>hasauthor, haslicense</li><li>thumbnail_height</li><li>thumbnail_title</li></ul><li>if
repo supported_returntypes returns FILE_EXTERNAL then it will try to
just make a link to the file/etc, and not download file when
$linkexternal (presumably when adding a link)</li><ul><li>We don't want people to link to /files/ in WebCTDB so we probably need one repository for files and a different one for links</li></ul></ul></ul><li>get_file($url, $filename = '') - get and save; url presumably from get_listing item url; by default just uses curl.</li><li>[get_link($url) - map iternal file url to normal url - only if URL is not really...]</li>
</ul><h2>WebCT-DB Repository Mapping</h2><p>There are a number of initial cases for the implementation of get_listing against WebCT-DB:</p><ul><li>Root [username] =&gt; user's home files, plus each module that they are a designer for (could include hierarchy)&nbsp;</li><ul><li>path '/USERNAME'</li></ul><li>Learning context =&gt; CMS (ContentEntry) hierarchy for Learning Context [optional]</li><ul><li>path .../lcNNN</li></ul><li>User's home files =&gt; CMS hierarchy for Person</li><ul><li>path .../pNNN</li></ul><li>ContentEntry =&gt; CMS children / links</li><ul><li>path .../ceNNN</li><li>path .../fcNNN/NAME.EXT</li></ul></ul><p>For file, there must be a way to serve the file content itself, initial from a simple URL</p><p>The get_listing implementation requires:</p><ul><li>username (presumed the same for WebCT and Moodle)</li><li>path - unique name for 'folder', i.e. [user] root, module learning context, person, cms 'folder'</li><li>[security - sequence, signature]</li></ul>
</body></html>